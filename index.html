<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login with LINE</title>
  <meta name="description" content="Demo หน้าเว็บที่มีปุ่มเข้าสู่ระบบด้วย LINE โดยใช้ LIFF SDK">
  
  <!-- ใส่ LIFF ID ที่นี่ หรือส่งผ่านพารามิเตอร์ URL ?liffId=YOUR_LIFF_ID -->
  <meta name="liff-id" content="2007800861-9aDaLaO3">

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans Thai, Arial, sans-serif;
      background: #f7f7f8;
      color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    main {
      width: 100%;
      max-width: 460px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding: 24px;
    }
    h1 { font-size: 1.25rem; margin: 0 0 8px; text-align: center; }
    #status { font-size: .95rem; color: #666; text-align: center; margin-bottom: 16px; }
    .profile { display: grid; grid-template-columns: 80px 1fr; gap: 16px; align-items: center; margin: 16px 0; }
    .profile img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #eee; }
    .muted { color: #555; font-size: .95rem; word-break: break-all; }
    button {
      width: 100%;
      border: 0;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-line { background: #06C755; color: white; }
    .btn-logout { background: #efefef; }
    details { background: #fafafa; border-radius: 12px; padding: 10px 12px; }
    summary { cursor: pointer; font-weight: 600; }
    pre { margin: 10px 0 0; max-height: 220px; overflow: auto; }
    footer { text-align: center; font-size: .8rem; color: #888; margin-top: 12px; }
  </style>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <main>
    <h1>เข้าสู่ระบบด้วย LINE</h1>
    <div id="status">พร้อมเริ่มใช้งาน</div>

    <div id="guest" hidden>
      <button id="loginBtn" class="btn-line">Login with LINE</button>
    </div>

    <div id="user" hidden>
      <div class="profile">
        <img id="pic" alt="รูปโปรไฟล์">
        <div>
          <div id="name" style="font-weight:700"></div>
          <div id="uid" class="muted"></div>
        </div>
      </div>
      <div id="idtokenWrap" style="margin:12px 0"></div>
      <button id="logoutBtn" class="btn-logout">ออกจากระบบ</button>
    </div>

    <footer>ตั้งค่า LIFF ID ให้ถูกต้องใน meta หรือพารามิเตอร์ URL</footer>
  </main>

  <script>
  ;(async function () {
    const $ = (s) => document.querySelector(s)
    const status = $('#status')
    const guest = $('#guest')
    const user = $('#user')
    const loginBtn = $('#loginBtn')
    const logoutBtn = $('#logoutBtn')
    const nameEl = $('#name')
    const uidEl = $('#uid')
    const picEl = $('#pic')

    const metaId = document.querySelector('meta[name="liff-id"]')
    const liffIdFromMeta = metaId && metaId.content && metaId.content !== 'YOUR_LIFF_ID_HERE' ? metaId.content : ''
    const liffIdFromQuery = new URLSearchParams(location.search).get('liffId') || ''
    const liffId = liffIdFromMeta || liffIdFromQuery

    function setStatus(msg) { status.textContent = msg }

    async function renderProfile() {
      setStatus('เข้าสู่ระบบแล้ว')
      const profile = await liff.getProfile()
      const idToken = liff.getIDToken()

      nameEl.textContent = `ชื่อ ${profile.displayName}`
      uidEl.textContent = `UID ${profile.userId}`
      if (profile.pictureUrl) { picEl.src = profile.pictureUrl } else { picEl.remove() }

      const wrap = document.createElement('details')
      const sum = document.createElement('summary')
      sum.textContent = 'ดู ID Token'
      const pre = document.createElement('pre')
      pre.textContent = idToken || ''
      wrap.appendChild(sum)
      wrap.appendChild(pre)
      const holder = document.getElementById('idtokenWrap')
      holder.replaceChildren(wrap)

      guest.hidden = true
      user.hidden = false
    }

    try {
      if (!liffId) {
        setStatus('ยังไม่มี LIFF ID ใส่ใน meta name="liff-id" หรือเพิ่มพารามิเตอร์ ?liffId=')
        guest.hidden = true
        return
      }

      setStatus('กำลังเตรียม LIFF')
      await liff.init({ liffId })

      if (!liff.isLoggedIn()) {
        guest.hidden = false
        user.hidden = true
      } else {
        await renderProfile()
      }

      loginBtn?.addEventListener('click', () => {
        if (liff.isInClient()) {
          // ปกติใน LINE แอปจะมีเซสชันอยู่แล้ว แต่เรียก login ไว้เพื่อความชัดเจน
          liff.login()
        } else {
          liff.login({ redirectUri: location.href })
        }
      })

      logoutBtn?.addEventListener('click', () => {
        liff.logout()
        location.reload()
      })
    } catch (err) {
      console.error(err)
      setStatus('เกิดข้อผิดพลาด ' + (err && err.message ? err.message : err))
      guest.hidden = true
    }
  })()
  </script>
</body>
</html>
