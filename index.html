<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Share Target Picker</title>
  <style>
    :root { --fg:#222; --muted:#6b7280; --bd:#e5e7eb; --accent:#10b981; --bg:#fff; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--fg);background:var(--bg)}
    .wrap{max-width:880px;margin:40px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 12px} p.muted{color:var(--muted);margin:0 0 24px}
    .row{display:flex;gap:14px;flex-wrap:wrap;margin:0 0 12px}
    input,textarea,button,details{font:inherit}
    input,textarea{width:100%;border:1px solid var(--bd);border-radius:10px;padding:12px}
    textarea{min-height:260px;line-height:1.4;resize:vertical;tab-size:2}
    .btn{border:1px solid var(--bd);background:#fff;border-radius:999px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.secondary{background:#f3f4f6}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .status{padding:8px 12px;border:1px dashed var(--bd);border-radius:10px;font-size:14px;color:#111;background:#fafafa}
    pre{white-space:pre-wrap;word-break:break-word;background:#111;color:#e5e7eb;padding:12px;border-radius:10px;overflow:auto}
    details{margin-top:8px}
  </style>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>LIFF Share Target Picker</h1>
    <p class="muted">หน้าทดสอบแชร์ Flex ผ่าน <code>liff.shareTargetPicker()</code> • ถ้าเปิดนอกแอป LINE ให้กด “เปิดในแอป LINE” ก่อน</p>

    <div id="status" class="status">กำลังโหลดคอนฟิก…</div>
    <div class="row">
      <button id="openLine" class="btn secondary" style="display:none">โปรดเปิดในแอป LINE…</button>
      <button id="loadsample" class="btn">ใส่ตัวอย่างเร็ว</button>
      <button id="loadTpl" class="btn">โหลดเทมเพลต</button>
      <button id="share" class="btn primary">แชร์</button>
    </div>

    <label for="alt">Alt Text</label>
    <input id="alt" placeholder="ใส่ข้อความ alt ของ Flex" />

    <div class="row" style="align-items:center;justify-content:space-between">
      <label for="json" style="margin:0">Flex JSON Contents</label>
      <span class="hint">วาง JSON จาก Flex Message Simulator ได้โดยตรง</span>
    </div>
    <textarea id="json" placeholder='{"type":"flex","altText":"...","contents":{...}}'></textarea>

    <details id="dbgBox">
      <summary>Debug</summary>
      <pre id="dbg">-</pre>
    </details>
  </div>

<script>
/** -------------------- utils -------------------- */
const $ = (id)=>document.getElementById(id);
const log = (...a)=>{ try{$('dbg').textContent = a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ');}catch{} };
const setStatus = (t)=> $('status').textContent = t;

/** อ่าน config + query */
async function loadConfig(){
  const r   = await fetch('./config.json?v=' + Date.now());
  const conf = await r.json();
  const qs   = new URLSearchParams(location.search);
  const idQS = qs.get('id');        // override ผ่าน URL: ?id=<LIFF_ID>
  const tpl  = qs.get('tpl');       // preload เทมเพลต: ?tpl=promo1
  const p    = qs.get('p');         // base64(JSON) override payload
  return { conf, liffId: idQS || conf.liffid, tpl, p, qs };
}

/** คืน LIFF สำหรับเทมเพลต (ถ้าตั้ง mapping) */
function getLiffIdForTpl(conf, name, fallback){
  return (conf.liffByTpl && conf.liffByTpl[name]) || fallback;
}

/** base64 → JSON object */
function b64ToJson(str){
  const utf8 = decodeURIComponent(escape(atob(str)));
  return JSON.parse(utf8);
}

/** โหลดไฟล์เทมเพลต */
async function loadTemplate(name){
  const r = await fetch(`./templates/${name}.json?${Date.now()}`);
  return await r.json();
}

/** สร้าง payload สำหรับ shareTargetPicker */
function buildMessages(){
  const raw = $('#json').value.trim();
  if(!raw) throw new Error('ยังไม่ได้ใส่ JSON');
  const data = JSON.parse(raw);
  const alt  = $('#alt').value.trim() || data.altText || 'Flex Message';
  const contents = data.contents || data.body || data; // เผื่อบางไฟล์วางมาแบบ core

  // รูปแบบ message ที่ shareTargetPicker รองรับ
  return [{ type:'flex', altText: alt, contents }];
}

/** เปิดในแอป LINE */
function openInLine(liffId){
  const here = encodeURIComponent(location.href);
  const url  = `line://app/${liffId}?referrer=${here}`;
  location.href = url;
}

/** -------------------- main -------------------- */
(async function main(){
  setStatus('กำลังโหลดคอนฟิก…');
  const { conf, liffId, tpl, p } = await loadConfig();
  log({conf,liffId,tpl,p});

  // ปุ่มเปิดในแอป LINE (แสดงไว้เผื่อเปิดในเบราว์เซอร์)
  $('openLine').style.display = 'inline-block';
  $('openLine').onclick = ()=> openInLine(liffId);

  setStatus('กำลังเตรียม LIFF…');
  await liff.init({ liffId });

  // ตรวจ login (บน in-app มักไม่ต้อง แต่ web อาจต้อง)
  if(!liff.isLoggedIn()){
    try{
      await liff.login({ scope:['profile','openid','chat_message.write'] });
      return; // LINE จะ redirect กลับมาอีกที
    }catch(e){
      console.warn('login skip', e);
    }
  }

  setStatus('พร้อมใช้งาน (ล็อกอิน/แก้ JSON แล้วกดแชร์)');

  // preload base64 payload ทาง ?p=
  if (p) {
    try{
      const data = b64ToJson(p);
      $('#alt').value  = data.altText || 'Flex Message';
      $('#json').value = JSON.stringify(data, null, 2);
    }catch(e){ console.warn('p decode fail', e); }
  }

  // preload template ทาง ?tpl=
  if (tpl) {
    try{
      const data = await loadTemplate(tpl);
      $('#alt').value  = data.altText || $('#alt').value;
      $('#json').value = JSON.stringify(data, null, 2);

      // ถ้ามี mapping liffByTpl ให้ re-init ด้วย LIFF ของเทมเพลต
      const perTplId = getLiffIdForTpl(conf, tpl, liffId);
      if (perTplId !== liffId) {
        setStatus('สลับ LIFF ตามเทมเพลต…');
        await liff.init({ liffId: perTplId });
        setStatus('พร้อมใช้งาน');
      }
    }catch(e){ console.warn('tpl preload fail', e); }
  }

  // ปุ่ม “ใส่ตัวอย่างเร็ว”
  $('loadsample').onclick = ()=>{
    const sample = {
      altText: 'โปรโมชันพิเศษ ☕',
      contents: {
        "type":"bubble",
        "hero":{"type":"image","url":"https://developers-resource.landpress.me/fx/img/review_gold_star_28.png","size":"full","aspectRatio":"20:13","aspectMode":"cover"},
        "body":{"type":"box","layout":"vertical","contents":[
          {"type":"text","text":"Brown Cafe","weight":"bold","size":"xl"},
          {"type":"text","text":"ส่วนลด 50% เฉพาะวันนี้!","margin":"md","wrap":true}
        ]}
      }
    };
    $('#alt').value  = sample.altText;
    $('#json').value = JSON.stringify(sample, null, 2);
  };

  // ปุ่ม “โหลดเทมเพลต”
  $('loadTpl').onclick = async ()=>{
    const name = prompt('พิมพ์ชื่อไฟล์ใน /templates (ไม่ต้อง .json)\nเช่น: promo1');
    if(!name) return;
    try{
      const data = await loadTemplate(name);
      $('#alt').value  = data.altText || $('#alt').value;
      $('#json').value = JSON.stringify(data, null, 2);

      // re-init ตาม mapping (ถ้ามี)
      const perTplId = getLiffIdForTpl(conf, name, liffId);
      if (perTplId !== liffId) {
        setStatus('สลับ LIFF ตามเทมเพลต…');
        await liff.init({ liffId: perTplId });
        setStatus('พร้อมใช้งาน');
      }
    }catch(e){ alert('โหลดเทมเพลตไม่สำเร็จ'); }
  };

  // ปุ่ม “แชร์”
  $('share').onclick = async ()=>{
    try{
      const msgs = buildMessages();
      const res  = await liff.shareTargetPicker(msgs);
      if (res) alert('ส่งแล้ว ✅');
    }catch(e){
      console.error(e);
      alert('แชร์ไม่สำเร็จ: ' + (e.message || e));
    }
  };
})().catch(err=>{
  console.error(err);
  setStatus('เกิดข้อผิดพลาดในการเริ่มต้น LIFF');
  log(err?.message || err);
});
</script>
</body>
</html>
