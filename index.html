<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Share via LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 24px; }
      .wrap { max-width: 720px; margin: 0 auto; }
      h1 { font-size: 22px; margin: 0 0 12px; }
      #status { padding: 12px 14px; border: 1px solid #ddd; border-radius: 8px; }
      .hint { color: #666; margin-top: 12px; font-size: 14px; }
      button { margin-top: 12px; padding: 10px 14px; border-radius: 8px; border: 0; background: #06c755; color: #fff; cursor: pointer; }
      button.secondary { background: #888; }
      pre { white-space: pre-wrap; font-size: 12px; background: #f6f6f6; padding: 8px; border-radius: 6px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>LIFF Share Target Picker</h1>
      <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ä‡∏£‡πå‚Ä¶</div>
      <div class="hint" id="hint"></div>
      <button id="retry" style="display:none">‡πÅ‡∏ä‡∏£‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      <button id="openInLine" class="secondary" style="display:none">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE</button>
      <details style="margin-top:12px">
        <summary>Debug</summary>
        <pre id="dbg"></pre>
      </details>
    </div>

    <script>
      // ===== config / query =====
      const qs = new URLSearchParams(location.search);
      const DEFAULT_LIFF_ID = "2007800861-9aDaLaO3";                // <-- ‡πÅ‡∏Å‡πâ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      const LIFF_ID = qs.get("id") || DEFAULT_LIFF_ID;       // ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á ?id= ‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå
      const TPL = qs.get("tpl");                             // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô /templates (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà .json)
      const P_B64URL = qs.get("p");                          // payload ‡πÅ‡∏ö‡∏ö base64url(JSON ‡∏´‡∏£‡∏∑‡∏≠ [JSON,...])
      const DEBUG = qs.has("debug");

      // ===== helpers =====
      const $ = (id) => document.getElementById(id);
      function setStatus(t){ $("status").textContent = t; }
      function setHint(t){ $("hint").textContent = t || ""; }
      function log(o){ $("dbg").textContent = (typeof o === "string") ? o : JSON.stringify(o, null, 2); }

      function b64urlDecodeToJson(s){
        try{
          let x = s.replace(/-/g, "+").replace(/_/g, "/");
          while (x.length % 4) x += "=";
          const str = atob(x);
          // atob ‚Üí UTF-8
          const utf8 = decodeURIComponent(escape(str));
          return JSON.parse(utf8);
        }catch(e){
          throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ p (base64url) ‡πÑ‡∏î‡πâ: " + e.message);
        }
      }

      async function loadMessages(){
        // 1) payload ‡∏ï‡∏£‡∏á‡∏ú‡πà‡∏≤‡∏ô ?p=
        if (P_B64URL){
          const data = b64urlDecodeToJson(P_B64URL);
          return Array.isArray(data) ? data : [data];
        }
        // 2) ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å /templates/*.json ‡∏ú‡πà‡∏≤‡∏ô ?tpl=
        if (TPL){
          const url = `templates/${encodeURIComponent(TPL)}.json?ts=${Date.now()}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${url}`);
          const data = await res.json();
          return Array.isArray(data) ? data : [data];
        }
        // 3) ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        return [{ type:"text", text:"Hello from LIFF üéâ" }];
      }

      function deepLinkToLine(){
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö shareTargetPicker)
        const q = location.search.replace(/^\?/, "");
        location.href = `https://liff.line.me/${encodeURIComponent(LIFF_ID)}${q ? "?" + q : ""}`;
      }

      async function shareOnce(){
        setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ä‡∏£‡πå‚Ä¶");
        setHint("");
        $("retry").style.display = "none";

        try {
          const messages = await loadMessages();
          log({ LIFF_ID, inClient: liff.isInClient(), apiShare: liff.isApiAvailable("shareTargetPicker"), messages });

          if (!liff.isInClient() || !liff.isApiAvailable("shareTargetPicker")){
            setStatus("shareTargetPicker ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ô‡∏µ‡πâ");
            setHint("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE");
            $("openInLine").style.display = "inline-block";
            return;
          }

          await liff.shareTargetPicker(messages);
          setStatus("‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì");

          // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà debug)
          if (!DEBUG) setTimeout(() => liff.closeWindow(), 800);

          // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏ï‡πà‡∏≠ ‡∏Å‡∏î retry
          $("retry").style.display = "inline-block";
        } catch (e) {
          setStatus("‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          setHint(String(e));
          $("retry").style.display = "inline-block";
        }
      }

      // ===== main =====
      (async () => {
        $("retry").onclick = shareOnce;
        $("openInLine").onclick = deepLinkToLine;

        try {
          await liff.init({ liffId: LIFF_ID });
        } catch (e) {
          setStatus("LIFF init ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
          setHint(String(e));
          $("openInLine").style.display = "inline-block";
          return;
        }

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ LINE ‚Üí ‡∏î‡∏µ‡∏û‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏û‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
        if (!liff.isInClient()){
          setStatus("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE‚Ä¶");
          deepLinkToLine();
          return;
        }

        // ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ä‡∏£‡πå
        await shareOnce();
      })();
    </script>
  </body>
</html>
