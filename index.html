<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Share Target Picker</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#222}
    .wrap{max-width:960px;margin:28px auto;padding:0 16px}
    h1{font-size:24px;margin:0 0 16px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:16px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    input[type=text],textarea{width:100%;box-sizing:border-box;border:1px solid #cfcfcf;border-radius:8px;padding:10px 12px;font:inherit}
    textarea{min-height:260px;line-height:1.45;white-space:pre}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{appearance:none;border:1px solid #d0d0d0;background:#fff;border-radius:8px;padding:10px 14px;font:inherit;cursor:pointer}
    button.primary{background:#06c755;border-color:#06c755;color:#fff;font-weight:700}
    details{margin-top:14px}
    pre{background:#111;color:#d9d9d9;padding:12px;border-radius:8px;overflow:auto}
    .muted{color:#6b7280}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="wrap">
  <h1>LIFF Share Target Picker</h1>

  <div class="card">
    <p class="muted">‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤
      <code>access.line.me</code> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>

    <div class="row">
      <button id="retry">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä/‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
      <button id="openInLine">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE</button>
      <button id="loadsample">‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Flex</button>
      <button id="loadTpl">‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô <code>/templates</code></button>
    </div>

    <label for="alt">Alt Text</label>
    <input id="alt" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‚ú®" />

    <label for="json">Flex JSON Contents (‡∏ß‡∏≤‡∏á JSON ‡∏à‡∏≤‡∏Å Flex Simulator ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)</label>
    <textarea id="json" spellcheck="false" placeholder='{"type":"bubble", ...}'></textarea>

    <div class="row">
      <button id="share" class="primary">‡πÅ‡∏ä‡∏£‡πå‡∏î‡πâ‡∏ß‡∏¢ Share Target Picker</button>
    </div>

    <details>
      <summary>Debug</summary>
      <pre id="dbg">-</pre>
    </details>

    <p id="status" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° LIFF...</p>
  </div>
</div>

<script>
  // ---------- helpers ----------
  const $ = id => document.getElementById(id);
  const log = (...a) => { console.log(...a); $('dbg').textContent = a.map(v=> {
    try { return typeof v === 'string' ? v : JSON.stringify(v,null,2); }
    catch(_) { return String(v); }
  }).join(' '); };

  const qs = new URLSearchParams(location.search);
  const Q_ID  = qs.get('id');          // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï override liffId ‡∏ú‡πà‡∏≤‡∏ô ?id=
  const Q_TPL = qs.get('tpl') || 'promo1';
  const Q_P   = qs.get('p');           // base64url(JSON message object)

  function b64urlToString(s){
    // base64url ‚Üí base64
    const b64 = s.replace(/-/g,'+').replace(/_/g,'/');
    try {
      // atob -> binary ‚Üí utf8
      return decodeURIComponent(escape(atob(b64)));
    } catch(e){
      // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ error ‡∏à‡∏≤‡∏Å escape/atob
      return atob(b64);
    }
  }
  function b64urlToJson(s){
    return JSON.parse(b64urlToString(s));
  }

  function setStatus(t){ $('status').textContent = t; }

  function sampleFlex(){
    return {
      type: "bubble",
      hero: { type:"image", url:"https://developers-resource.landpress.me/fx/img/review_gold_star_28.png",
              size:"full", aspectRatio:"20:13", aspectMode:"cover" },
      body: { type:"box", layout:"vertical", contents: [
        { type:"text", text:"Brown Cafe", weight:"bold", size:"xl" },
        { type:"text", text:"‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 50% ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!", margin:"md", wrap:true }
      ]}
    };
  }

  function buildMessages(){
    const alt = $('alt').value || 'Flex Message';
    let json;
    try {
      json = JSON.parse($('json').value.trim());
    } catch(e){
      alert('JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); throw e;
    }

    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö input
    if (Array.isArray(json)) return json;                         // ‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á message objects ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    if (json.type === 'flex' && json.contents) return [json];     // ‡πÄ‡∏õ‡πá‡∏ô flex object ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
    if (json.contents) return [{ type:'flex', altText: alt, contents: json }]; // ‡πÄ‡∏õ‡πá‡∏ô contents ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    return [{ type:'text', text: JSON.stringify(json).slice(0,1000) }];
  }

  async function loadMessagesIntoEditor(){
    if (Q_P){                      // 1) p= base64url(JSON)
      try{
        const data = b64urlToJson(Q_P);
        $('json').value = JSON.stringify(data, null, 2);
        if (data.altText && !$('alt').value) $('alt').value = data.altText;
        return;
      }catch(e){ console.warn(e); }
    }
    // 2) ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å /templates/{tpl}.json
    try{
      const r = await fetch(`./templates/${Q_TPL}.json?${Date.now()}`);
      const data = await r.json();
      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á object ‡∏ó‡∏µ‡πà‡∏°‡∏µ type:flex ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡∏°‡∏µ contents ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      const forEdit = (data.type==='flex' && data.contents) ? data.contents : data;
      $('json').value = JSON.stringify(forEdit, null, 2);
      if (data.altText) $('alt').value = data.altText;
      return;
    }catch(e){ console.warn(e); }

    // 3) ‡∏ï‡∏Å‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
    $('json').value = JSON.stringify(sampleFlex(), null, 2);
    if (!$('alt').value) $('alt').value = '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‚òïÔ∏è';
  }

  // ---------- main ----------
  async function main(){
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î config.json ...');
    const conf = await fetch('./config.json').then(r => r.json());
    const liffId = Q_ID || conf.liffByTpl?.[Q_TPL] || conf.liffid;

    if (!liffId){
      setStatus('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö liffId (‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡πÉ‡∏ô config.json ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡πà‡∏≤‡∏ô ?id=)');
      throw new Error('no liffId');
    }

    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á init LIFF ...');
    await liff.init({ liffId });

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (access.line.me) ‡πÄ‡∏™‡∏°‡∏≠
    if (!liff.isLoggedIn()){
      setStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');
      liff.login({ redirectUri: location.href }); // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏±‡∏á login
      return;
    }

    setStatus('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° editor ...');
    await loadMessagesIntoEditor();
    setStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úì (‡∏•‡∏∏‡∏¢‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)');
    log({ liffId, inClient: liff.isInClient(), os: liff.getOS?.() });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
    $('retry').onclick = () => { location.reload(); };
    $('openInLine').onclick = () => {
      // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LIFF ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ shareTargetPicker ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
      liff.openWindow({ url: location.href, external: false });
    };
    $('loadsample').onclick = () => {
      const data = sampleFlex();
      $('json').value = JSON.stringify(data, null, 2);
      if (!$('alt').value) $('alt').value = '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‚òïÔ∏è';
    };
    $('loadTpl').onclick = async () => {
      const name = prompt('‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á .json)\n‡πÄ‡∏ä‡πà‡∏ô: promo1');
      if (!name) return;
      try{
        const r = await fetch(`./templates/${name}.json?${Date.now()}`);
        const data = await r.json();
        const forEdit = (data.type==='flex' && data.contents) ? data.contents : data;
        $('json').value = JSON.stringify(forEdit, null, 2);
        if (data.altText) $('alt').value = data.altText;
      }catch(e){ alert('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
    };
    $('share').onclick = async () => {
      try{
        if (!liff.isApiAvailable('shareTargetPicker')){
          alert('shareTargetPicker ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ô‡∏µ‡πâ\n‡∏•‡∏≠‡∏á‡∏Å‡∏î "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE" ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ä‡∏£‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
          return;
        }
        const msgs = buildMessages();
        // ‡πÄ‡∏ï‡∏¥‡∏° altText ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏ì‡∏µ contents-only
        msgs.forEach(m=>{
          if (m.type==='flex' && !m.altText) m.altText = $('alt').value || 'Flex Message';
        });
        const res = await liff.shareTargetPicker(msgs);
        if (res) alert('‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß üéâ');
      }catch(e){
        console.error(e);
        alert('‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e));
      }
    };
  }

  main().catch(err=>{
    console.error(err);
    setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF ‚Äî ‡∏î‡∏π console/Debug');
    log(err?.message || err);
  });
</script>
</body>
</html>
