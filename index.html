<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Share Target Picker</title>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai",sans-serif;line-height:1.45;
         margin:28px;color:#222}
    .wrap{max-width:920px;margin:auto}
    h1{font-size:26px;margin:0 0 16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 14px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
    button.primary{background:#06c755;color:#fff;border-color:#06c755}
    input,textarea{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:8px;padding:10px}
    textarea{min-height:300px;font-family:ui-monospace,Consolas,monospace}
    .muted{color:#666;font-size:13px}
    .hide{display:none}
    details{margin-top:8px}
    pre{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:10px}
    .right{margin-left:auto}
  </style>
</head>
<body>
<div class="wrap">
  <h1>LIFF Share Target Picker</h1>
  <p class="muted">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ä‡∏£‡πå Flex ‡∏ú‡πà‡∏≤‡∏ô <code>liff.shareTargetPicker()</code>.
  ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ LINE ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≤‡∏à‡∏û‡∏≤‡πÑ‡∏õ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ä‡∏£‡πå</p>

  <!-- ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
  <div id="status" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</div>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏î login (‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÑ‡∏î‡πÄ‡∏£‡πá‡∏Å‡∏ï‡πå) -->
  <div id="loginBox" class="row hide">
    <button id="btnLogin" class="primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE</button>
    <button id="btnOpenInLine" title="‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)"><b>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE</b></button>
  </div>

  <!-- UI ‡∏´‡∏•‡∏±‡∏Å: ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß -->
  <div id="uiMain" class="hide">
    <div class="row">
      <button id="openInLine" class="hide">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE‚Ä¶</button>
      <button id="loadSample">‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡πá‡∏ß</button>
      <button id="loadTpl">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</button>
      <button id="btnShare" class="primary">‡πÅ‡∏ä‡∏£‡πå</button>
      <button id="btnLogout" class="right">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <label for="alt"><b>Alt Text</b></label>
    <input id="alt" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° alt ‡∏Ç‡∏≠‡∏á Flex" />

    <div class="row" style="margin-top:8px">
      <label for="json"><b>Flex JSON Contents</b> <span class="muted">‡∏ß‡∏≤‡∏á JSON ‡∏à‡∏≤‡∏Å Flex Message Simulator ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</span></label>
      <textarea id="json" placeholder='{"type":"flex","altText":"...","contents":{...}}'></textarea>
    </div>

    <details>
      <summary>Debug</summary>
      <pre id="dbg"></pre>
    </details>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (o)=>{ $('dbg').textContent = (typeof o==='string'?o:JSON.stringify(o,null,2)); };

  const qs = new URLSearchParams(location.search);

  function setStatus(t){ $('status').textContent = t; }

  function b64ToJson(b64){
    const utf8 = decodeURIComponent(escape(atob(b64)));
    return JSON.parse(utf8);
  }

  async function loadConfig(){
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏Ñ‡∏ä‡∏´‡∏ô‡πâ‡∏≤ GitHub Pages
    const res = await fetch('./config.json?'+Date.now());
    if(!res.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î config.json ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    return res.json();
  }

  async function ensureLogin(liff){
    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‚Üí ‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ: ‡∏£‡∏µ‡πÑ‡∏î‡πÄ‡∏£‡πá‡∏Å‡∏ï‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login ‡∏Ç‡∏≠‡∏á LINE ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    if(!liff.isLoggedIn()){
      if(!liff.isInClient()){
        // ‡∏Å‡∏±‡∏ô‡∏•‡∏π‡∏õ: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ?noauto ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÑ‡∏î‡πÄ‡∏£‡πá‡∏Å‡∏ï‡πå (‡πÑ‡∏ß‡πâ‡∏î‡∏µ‡∏ö‡∏±‡∏Å)
        if(!qs.has('noauto')){
          setStatus('‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE‚Ä¶');
          liff.login({ redirectUri: location.href });
          return false; // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠
        }
      }
      // ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏´‡∏¢‡∏∏‡∏î: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏≠‡∏á
      $('loginBox').classList.remove('hide');
      $('btnLogin').onclick = ()=> liff.login({ redirectUri: location.href });
      $('btnOpenInLine').onclick = ()=> liff.openWindow({ url: location.href, external: false });
      setStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
      return false;
    }
    return true;
  }

  async function main(){
    try{
      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‚Ä¶');
      const cfg = await loadConfig();
      const LIFF_ID = qs.get('id') || cfg.liffid;
      if(!LIFF_ID){ setStatus('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ LIFF ID ‡πÉ‡∏ô config.json'); return; }

      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏° LIFF‚Ä¶');
      await liff.init({ liffId: LIFF_ID });

      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏à‡∏∞‡∏£‡∏µ‡πÑ‡∏î‡πÄ‡∏£‡πá‡∏Å‡∏ï‡πå/‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î
      const ok = await ensureLogin(liff);
      if(!ok) return;

      // ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      $('uiMain').classList.remove('hide');
      setStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úì');

      // ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ? ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE
      if(!liff.isApiAvailable('shareTargetPicker')){
        $('openInLine').classList.remove('hide');
        $('openInLine').onclick = ()=> liff.openWindow({ url: location.href, external: false });
      }

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å query (?p=base64 ‡∏Ç‡∏≠‡∏á JSON / ?tpl=‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô templates)
      async function preset(){
        // base64 ‚Üí JSON
        const p = qs.get('p');
        if(p){
          try{
            const data = b64ToJson(p);
            $('json').value = JSON.stringify(data, null, 2);
            $('alt').value  = data.altText || $('alt').value;
            return;
          }catch(e){ console.warn('p base64 invalid', e); }
        }
        // templates
        const tpl = qs.get('tpl');
        if(tpl){
          try{
            const r = await fetch('./templates/'+tpl+'.json?'+Date.now());
            const data = await r.json();
            $('json').value = JSON.stringify(data, null, 2);
            $('alt').value  = data.altText || $('alt').value;
          }catch(e){ console.warn('template not found', e); }
        }
      }

      // ‡∏õ‡∏∏‡πà‡∏°/‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå
      $('loadSample').onclick = ()=>{
        const sample = {
          type:'flex',
          altText:'‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Flex',
          contents:{
            type:'bubble',
            body:{ type:'box', layout:'vertical', contents:[
              { type:'text', text:'Brown Cafe', weight:'bold', size:'xl' },
              { type:'text', text:'‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 50% ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!', margin:'md', wrap:true }
            ]}
          }
        };
        $('alt').value  = sample.altText;
        $('json').value = JSON.stringify(sample, null, 2);
      };

      $('loadTpl').onclick = async ()=>{
        const name = prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô /templates (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà .json)\n‡πÄ‡∏ä‡πà‡∏ô: promo1');
        if(!name) return;
        try{
          const r = await fetch('./templates/'+name+'.json?'+Date.now());
          const data = await r.json();
          $('json').value = JSON.stringify(data, null, 2);
          $('alt').value  = data.altText || $('alt').value;
        }catch(e){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå '+name+'.json'); }
      };

      $('btnShare').onclick = async ()=>{
        try{
          const obj = JSON.parse($('json').value || '{}');
          const alt = $('alt').value || obj.altText || 'Flex Message';
          const msgs = [{ type:'flex', altText: alt, contents: obj.contents || obj }];
          const res = await liff.shareTargetPicker(msgs);
          if(res){ alert('‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß üéâ'); }
        }catch(e){
          console.error(e);
          alert('‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e));
        }
      };

      $('btnLogout').onclick = ()=>{ liff.logout(); location.reload(); };

      await preset();
      log({
        os: liff.getOS && liff.getOS(),
        inClient: liff.isInClient(),
        shareApi: liff.isApiAvailable('shareTargetPicker')
      });
    }catch(err){
      console.error(err);
      setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(err.message||err));
      log(err.stack || String(err));
    }
  }

  main();
})();
</script>
</body>
</html>
