<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Share Target Picker</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fafafa;color:#222}
    .wrap{max-width:920px;margin:32px auto;padding:0 16px}
    h1{font-size:26px;margin:0 0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    label{display:block;font-size:14px;margin-bottom:6px;color:#666}
    input[type="text"], textarea{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:10px;padding:10px 12px;font-size:14px;background:#fff}
    textarea{min-height:220px;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .primary{background:#06c755;color:#fff}
    .ghost{background:#eef2f7}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#eef7f0;color:#065f46;border-radius:999px;padding:6px 10px;font-size:13px}
    .spacer{flex:1}
    details{margin-top:10px}
    pre{background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;white-space:pre-wrap}
    .muted{color:#888}
  </style>
</head>
<body>
<div class="wrap">
  <h1>LIFF Share Target Picker</h1>

  <div class="card row">
    <div id="who" class="pill" style="display:none"></div>
    <div class="spacer"></div>
    <button id="login"  class="primary">Login with LINE</button>
    <button id="logout" class="ghost"   style="display:none">Logout</button>
    <button id="openInApp" class="ghost" title="‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE‚Ä¶</button>
  </div>

  <div class="card">
    <div class="row">
      <button id="loadTpl" class="ghost">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï (templates)</button>
      <button id="loadSample" class="ghost">‡πÉ‡∏™‡πà Sample Flex</button>
      <div class="spacer"></div>
      <button id="share" class="primary">‡πÅ‡∏ä‡∏£‡πå (shareTargetPicker)</button>
    </div>

    <div style="margin-top:12px">
      <label for="alt">Alt Text</label>
      <input id="alt" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©..." />
    </div>

    <div style="margin-top:12px">
      <label for="json">Flex JSON Contents</label>
      <textarea id="json" placeholder='‡∏ß‡∏≤‡∏á JSON ‡∏à‡∏≤‡∏Å Flex Message Simulator ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà'></textarea>
    </div>

    <details id="dbgWrap">
      <summary>Debug</summary>
      <pre id="dbg">-</pre>
    </details>
  </div>

  <p class="muted">
    ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå: <code>?id=&lt;LIFF_ID&gt;</code>, <code>?tpl=promo1</code>, <code>?p=&lt;base64(JSON ‡∏´‡∏£‡∏∑‡∏≠ [JSON,...])&gt;</code>
  </p>
</div>

<script>
/* ===== Query / helpers ===== */
const qs = new URLSearchParams(location.search);
const TPL = qs.get('tpl');
const DEBUG = qs.has('debug');

const $ = id => document.getElementById(id);
const log = (...a)=>{ if(!DEBUG) return; $('dbg').textContent = a.map(x=>{
  try{ return typeof x==='string'?x:JSON.stringify(x,null,2); }catch(e){ return String(x); }
}).join("\n"); $('dbgWrap').open = true; };

function b64urlToText(s){
  s = s.replace(/-/g,'+').replace(/_/g,'/'); while (s.length % 4) s+='=';
  return new TextDecoder().decode(Uint8Array.from(atob(s), c=>c.charCodeAt(0)));
}

/* ===== Load LIFF ID: ?id= ‚Üí config.json ‚Üí error ===== */
async function getLiffId(){
  const fromUrl = qs.get('id');
  if (fromUrl) return fromUrl;
  const cfgUrl = './config.json?v=' + Date.now(); // ‡∏Å‡∏±‡∏ô cache
  try{
    const cfg = await fetch(cfgUrl).then(r=>r.json());
    if (TPL && cfg.liffByTpl && cfg.liffByTpl[TPL]) return cfg.liffByTpl[TPL];
    if (cfg.liffId) return cfg.liffId;
  }catch(e){ log('config.json error', e); }
  throw new Error('NO_LIFF_ID: ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡πà‡∏á ?id= ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡πÉ‡∏ô config.json');
}

/* ===== Load payload from ?p or templates/<tpl>.json ===== */
async function presetPayload(){
  const p = qs.get('p');
  if (p){
    try{
      const text = b64urlToText(p);
      const data = JSON.parse(text);
      $('json').value = JSON.stringify(data, null, 2);
      log('loaded from ?p', data);
      return;
    }catch(e){ log('bad ?p', e); }
  }
  if (TPL){
    try{
      const res = await fetch(`./templates/${TPL}.json?${Date.now()}`);
      const data = await res.json();
      $('json').value = JSON.stringify(data, null, 2);
      if (data.altText) $('alt').value = data.altText;
      log('loaded template', data);
    }catch(e){ log('load tpl error', e); }
  }
}

/* ===== Convert editor ‚Üí LINE messages ===== */
function buildMessages(){
  const alt = $('alt').value.trim() || 'Flex Message';
  let obj;
  try{ obj = JSON.parse(($('json').value || '').trim() || '{}'); }
  catch(e){ alert('JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); throw e; }

  const list = Array.isArray(obj) ? obj : [obj];
  return list.map(it => (it.type === 'flex' ? it : { type:'flex', altText: alt, contents: it }));
}

/* ===== Bootstrap ===== */
async function main(){
  const liffId = await getLiffId();
  log('using LIFF ID', liffId);
  await liff.init({ liffId });

  $('login').onclick  = () => liff.login({ redirectUri: location.href });
  $('logout').onclick = () => { liff.logout(); location.reload(); };
  $('openInApp').onclick = () => liff.openWindow({ url: location.href, external:false });

  if (liff.isLoggedIn()){
    $('login').style.display = 'none';
    $('logout').style.display = '';
    try{
      const p = await liff.getProfile();
      $('who').style.display = '';
      $('who').textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${p.displayName}`;
    }catch(e){ log('profile error', e); }
  }else{
    $('logout').style.display = 'none';
  }

  $('loadSample').onclick = () => {
    const sample = {
      type: "flex",
      altText: "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Flex",
      contents: {
        type: "bubble",
        body: { type: "box", layout: "vertical", contents: [
          { type: "text", text: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üëã", weight: "bold", size: "xl" },
          { type: "text", text: "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á", margin: "md", wrap: true }
        ] }
      }
    };
    $('alt').value  = sample.altText;
    $('json').value = JSON.stringify(sample, null, 2);
  };

  $('loadTpl').onclick = async () => {
    const name = prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á .json)\n‡πÄ‡∏ä‡πà‡∏ô: promo1');
    if (!name) return;
    try{
      const r = await fetch(`./templates/${name}.json?${Date.now()}`);
      const data = await r.json();
      $('json').value = JSON.stringify(data, null, 2);
      $('alt').value  = data.altText || $('alt').value;
    }catch(e){ alert('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
  };

  $('share').onclick = async () => {
    try{
      const msgs = buildMessages();
      const res = await liff.shareTargetPicker(msgs);
      if (res) alert('‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß üéâ'); // res: { status: 'success' ... }
    }catch(e){
      console.error(e);
      alert('‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e?.message || e));
    }
  };

  await presetPayload();
}

main().catch(err=>{
  console.error(err);
  alert('LIFF init error: ' + (err?.message || err));
  log(err);
});
</script>
</body>
</html>
